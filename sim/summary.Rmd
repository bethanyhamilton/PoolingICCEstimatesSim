---
title:  Meta-Analyzing ICC Estimates Results Summary"
author: "Bethany"
output2 html_dogument
---

```{r setup, Include=FALCE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
library(tidyverse)
library(kableExtra)
library(ggplot2)

load("ICC_sim_results_smithcorr1.Rdata")
results1 <- results
load("ICC_sim_results_smithcorr2.Rdata")
results2 <- results
load("ICC_sim_results_smithcorr3.Rdata")
results3 <- results
load("ICC_sim_results_smithcorr4.Rdata")
results4 <- results
load("ICC_sim_results_smithcorr5.Rdata")
results5 <- results
load("ICC_sim_results_smithcorr6.Rdata")
results6 <- results
load("ICC_sim_results_smithcorr7.Rdata")
results7 <- results
load("ICC_sim_results_smithcorr8.Rdata")
results8 <- results
load("ICC_sim_results_smithcorr9.Rdata")
results9 <- results
load("ICC_sim_results_smithcorr10.Rdata")
results10 <- results

results <- bind_rows(results1, results2, results3, results4, results5, results6, results7, results8, results9, results10)

#save(results, file =  "results.Rdata")

#load( "results.Rdata")

source("3_performance_crit.R")

#results <- results %>% filter(var_icc_name != "Smith")

##### this is for the RSE
# results <- results %>% mutate(
#     pooled_icc_est2 = ifelse( var_icc_name == "Fisher TF",  .5*log((1+(n_weighted-1)*pooled_icc_est)/(1-pooled_icc_est)),pooled_icc_est  )
# 
# )
```

```{r}
results2 <- results %>% filter(sample_conv != "no") %>% filter(all_converge == TRUE)

perf_crit <- calc_performance(results2)

perf_crit <- perf_crit %>% tidyr::unite("method2",  c( method, var_icc_name)) %>%
  mutate(method2 = str_replace(method2, "_", "\n"))
```

sampling urror variance
```{r}

results_test <- results %>% mutate(prop = (tau^2)/(tau^2 + ((se_pooled_icc_est)^2-tau^2)) )

```




below is just a summary of how many iterations we used for this project.
```{r}
# K_all <- results %>%
#   select( iterations) %>%
#   distinct(.) %>%
#   summarize(iterations = sum(iterations)) %>%
#   pull(iterations) 
# 
# mcse = sqrt(.05 * (1 - .05) / K_all)
# error = .05 + 1.96 * mcse
```

## MCSE

What is the best way to summarize this? Also, I’m not sure about the MCSE for the RPB. Can we talk about that as some point?

```{r}

# Check mcse
mcse_summary <- perf_crit  %>%
  group_by(method2) %>%
  summarize(RMSE_mcse_min = min(RMSE_rel_bias_icc_mcse),
            RMSE_mcse_max = max(RMSE_rel_bias_icc_mcse),
            RPB_mcse_min = min(rel_bias_icc_mcse),
            RPB_mcse_max = max(rel_bias_icc_mcse),
            PB_mcse_min = min(bias_icc_mcse),
            PB_mcse_max = max(bias_icc_mcse),)

# MCSE for rmse all less than 0.01
mcse1 <- perf_crit %>% filter(RMSE_rel_bias_icc_mcse > 0.01)

#### MCSE for rel pb


mcse2 <- perf_crit %>% filter(rel_bias_icc_mcse > 0.01)

mcse_summary %>% kable()
```

Convergence – redo this

It looks like the lowest convergence rate was 96.8%. 139 conditions/method combos had convergence rates less than 100.

Also, it looks like only REML did not converge (except when using the Fisher TF variance). Also it looks like issues with convergence tend to happen when the L2 variance is small or moderate in magnitude.

```{r, eval =FaLSE}
# converge_sum <- perf_crit %>% filter(!grepl('NA', method2)) %>% 
#   group_by(method2, icc_est_n, nj_size, n_bar_size, n_bar_prop, var_combo, tau) %>%
#   mutate(converged = ifelse(K == 1500, "yes", "no"),
#          num_no_converge = ifelse(converged == "no", 1000-K , 0),
#          num_converge = 1500-num_no_converge,
#          convergence_rate = (K/1500)*100) %>% ungroup()
# 
# min(converge_sum$convergence_rate)
# which(converge_sum$convergence_rate < 100)
# 
# 
# # number of samples that did not converge per method.
# converge_sum %>% group_by(method2) %>% 
#   summarise(total_non_convergence = sum(num_no_converge, na.rm = TRUE),
#             total_converged = sum(num_converge, na.rm= TRUE),
#             converge_rate = (total_converged/96000)*100 ) %>% ungroup()
# 
# conditions_conv <- converge_sum %>% 
#   group_by(icc_est_n, nj_size, n_bar_size, n_bar_prop, var_combo, tau) %>% 
#   summarise(total_non_convergence = sum(num_no_converge, na.rm = TRUE)) %>% 
#   arrange(total_non_convergence) %>% filter(total_non_convergence != 0)  %>% ungroup()
# 
# 
# conditions_conv %>% group_by(var_combo) %>% summarise(num_failed_conv = sum (total_non_convergence))

# conditions_num <- conditions_conv %>%
#   summarise(icc_est_n.50 = sum(icc_est_n==50),
#             icc_est_n.150 = sum(icc_est_n==150),
#             nj.30 = sum(nj==30),
#             nj.100 = sum(nj==100),
#             n_bar.10 = sum(n_bar==10),
#             n_bar.50 = sum(n_bar==50),
#             n_bar_prop.none = sum(n_bar_prop==0.0),
#             n_bar_prop.half = sum(n_bar_prop==0.5),
#             var_combo.small_small = sum(var_combo=="small_small"),
#             var_combo.medium_small = sum(var_combo=="medium_small"),
#             var_combo.large_small = sum(var_combo=="large_small"),
#             var_combo.small_large = sum(var_combo=="small_large"),
#             var_combo.medium_large = sum(var_combo=="medium_large"),
#             var_combo.large_large = sum(var_combo=="large_large"),
#             tau.none = sum(tau==0.0))
```


```{r}


results3 <- results %>% filter(sample_conv == "no") %>% filter(all_converge == TRUE)

converge_sum <- results %>% tidyr::unite("method2",  c( method, var_icc_name)) %>%
  mutate(method2 = str_replace(method2, "_", "\n")) %>% group_by(method2, icc_est_n, nj_size, n_bar_size, n_bar_prop, var_combo, tau) %>%
  summarise(num_no_converge = sum(is.na(pooled_icc_est)),
         num_converge = 1500-num_no_converge,
         num_converge2 = sum(!is.na(pooled_icc_est)),
         converge_rate = num_converge/1500 *100,
         nonconverge_rate= num_no_converge/1500 *100,
         k = n()) %>% ungroup()



min(converge_sum$converge_rate)
#which(converge_sum$converge_rate < 100)


# number of samples that did not converge per method.
converge_sum %>% group_by(method2) %>% 
  summarise(total_non_convergence = sum(num_no_converge, na.rm = TRUE),
            total_converged = sum(num_converge, na.rm= TRUE),
            k = n(),
            converge_rate = (total_converged/(total_non_convergence +total_converged))*100 ) %>% ungroup()

conditions_conv <- results %>% 
  group_by(icc_est_n, nj_size, n_bar_size, n_bar_prop, var_combo, tau, method) %>%
  summarise(num_no_converge = sum(is.na(pooled_icc_est)),
         num_converge = 15000-num_no_converge,
         num_converge2 = sum(!is.na(pooled_icc_est)),
         converge_rate = num_converge/15000 *100,
         nonconverge_rate= num_no_converge/15000 *100,
         k = n()) # %>% filter(num_no_converge != 0)  


conditions_conv3 <- results %>% 
  group_by(icc_est_n, nj_size, n_bar_size, n_bar_prop, var_combo, tau) %>%
  summarise(num_no_converge = sum(is.na(pooled_icc_est)),
         num_converge = 15000-num_no_converge,
         num_converge2 = sum(!is.na(pooled_icc_est)),
         converge_rate = num_converge/15000 *100,
         nonconverge_rate= num_no_converge/15000 *100,
         k = n())

conditions_conv2 <- results %>% 
  group_by(icc_est_n, nj_size, n_bar_size, n_bar_prop, var_combo, tau,method, var_icc_name) %>%
  summarise(num_no_converge = sum(is.na(pooled_icc_est)),
         num_converge = 1500-num_no_converge,
         num_converge2 = sum(!is.na(pooled_icc_est)),
         converge_rate = num_converge/1500 *100,
         nonconverge_rate= num_no_converge/1500 *100,
         k = n())  #%>% filter(num_no_converge != 0)  

conditions_conv2 %>% filter(num_converge != 1500) %>% ungroup() %>% summarise(min = min(converge_rate))

conditions_conv2 %>% filter(num_converge == 1500) %>% filter(method == "REML")
```


# Trying to remove samples that did not converge. 


```{r}

# results$samples <- rep(1:96000, each=12)
# 
# seeds_noconv<- results %>% filter(is.na(var_icc_name)) %>% select(seed, samples) %>% distinct()
# 
# seeds_noconv <- as.list(seeds_noconv)
# 
# results <- results %>% filter(!samples %in% seeds_noconv$samples) 
# 
# length(unique(results$samples))


 # results %>%  filter(tau == 0.0) %>% filter(sample_conv != "no") %>% group_by(seed) %>% tally() 
## making sure every condition has the same number of samples. 




results <- results %>% group_by(icc_est_n, nj_size, n_bar_prop, n_bar_size, tau, var_combo) %>% mutate(combination_id = cur_group_id())


results  %>% group_by(combination_id) %>% tally()



results %>% filter(sample_conv != "no") %>% filter(all_converge == TRUE) %>% group_by(combination_id) %>% tally()



#maybe need to do combination ID and method?
results <-
results %>% filter(sample_conv != "no") %>% filter(all_converge == TRUE) %>% group_by(combination_id) %>% 
  slice(1:10000) %>% ungroup()

perf_crit <- calc_performance(results)

perf_crit <- perf_crit %>% tidyr::unite("method2",  c( method, var_icc_name)) %>%
  mutate(method2 = str_replace(method2, "_", "\n"))



perf_crit2 <- calc_performance_var(results)




```




# Graphs

Below are graphs looking at the results for RPB and RMSE for the pooled ICC estimate. 

```{r}

perf_crit$var_combo_graph <- factor(perf_crit$var_combo,labels=c(
  'small_large'=0.05,
  'medium_large'=0.15,
  'large_large'=0.25)) 

perf_crit <- perf_crit %>% mutate(
  var_combo_graph = case_when(
    var_combo == 'small_large' ~ 0.05,
    var_combo == 'medium_large' ~ 0.15,
    var_combo == 'large_large' ~ 0.25,
  )
) 





perf_crit <- perf_crit %>% mutate(
  nj_size = case_when(
    nj_size == "small" ~'U[30, 50]',

    nj_size == "large" ~'U[50, 100]',
  ))
  


perf_crit <- perf_crit %>% mutate(
  n_bar_size = case_when(
    n_bar_size == "small" ~'U[10, 30]',

    n_bar_size == "large" ~'U[30, 50]',
  ))
  


# levels(perf_crit$var_combo) <- c( 
#  
#   
#   expression( atop( tau^"2"*"= .05", rho*"= 0.05") ),
#   expression( atop(tau^"2"*"= .15", rho*"= 0.15")),
#   expression( atop(tau^"2"*"= .25", rho*"= 0.25")),
#   expression( atop(tau^"2"*"= 5", rho*"= 0.05")),
#   expression( atop(tau^"2"*"= 15", rho*"= 0.15")),
#   expression( atop(tau^"2"*"= 25", rho*"= 0.25")))


perf_crit <- perf_crit %>% mutate(n_bar_graph = paste("n_bar_size = ", n_bar_size), 
                                  nj_graph = paste("nj_size = ", nj_size), 
                                  icc_est_n_graph = paste("k = ", icc_est_n)
                                  #,
                                  # var_combo_graph = case_when(
                                  #   var_combo == "large_large" ~ "Large /tau^2 // Large Total Var.",
                                  #   var_combo == "small_small" ~ "Small /tau^2 // Small Total Var.",
                                  #   var_combo == "medium_small" ~ "Medium /tau^2 // Small Total Var.",
                                  #   var_combo == "large_small" ~ "Large /tau^2 // Small Total Var.",
                                  #   var_combo == "small_large" ~ "Small /tau^2 // Large Total Var.",
                                  #   var_combo == "medium_large" ~ "Medium /tau^2 // Large Total Var.",

                                 # )
                                  #,
                                  #var_combo_graph = str_replace(var_combo, "_", "/\n")
                                  )

perf_crit$icc_est_n_graph <- factor(perf_crit$icc_est_n_graph,levels=c(
  "k =  20",
  "k =  50",
  "k =  100"))

perf_crit <- perf_crit  %>% separate(
  method2, into = c("model", "variance"), sep = "\n", remove = FALSE 
) %>% mutate(variance = ifelse( variance == "Fisher TF", "Fisher\nTF", variance))
```



```{r}
# nbar vs nj_size

# 
# perf_crit  %>% ggplot( aes( x = method2, y = rel_bias_icc, fill = method2)) + 
#   geom_hline(yintercept = .05, linetype = "dashed")  + 
#   geom_hline(yintercept = -.05, linetype = "dashed")  + 
#   geom_boxplot(alpha = .5) + 
#   facet_grid(n_bar_graph ~ nj_graph) + 
#   labs(x = "Method", y = "Relative Parameter Bias") + 
#   theme_bw() +
#   theme(legend.position = "none",
#         axis.text.x = element_text(size = 5),
#         plot.caption=element_text(hjust = 0, size = 10),
#         legend.title=element_text(size = 11), 
#         legend.text=element_text(size = 11))
```


# Pooled Estimate 

## Interactions

### var_combo vs num pooled ICCs
using mean
```{r}

#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=800)
#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=300)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_numICC.png", width = 6.8, height = 5, units = "in")






perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_numICC.png", width = 6.8, height = 5, units = "in")
```

using median


```{r}

#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=800)
#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=300)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_numICC_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc_median, fill = model)) + 
   geom_hline(yintercept = .00, linetype = "dashed")  + 

  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_numICC_median.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```





### var_combo vs tau (between study )

using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_tau.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed") + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_tau.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```


using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_tau_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed") + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_tau_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```



### var_combo vs number of clusters

using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_j.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_j.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```


using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_j_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_j_median.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```

### var_combo vs cluster size

using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_nj.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_nj.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```



using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_nj_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_nj_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```


### number clusters vs cluster size
using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_j_nj.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_j_nj.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```
using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_j_nj_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_j_nj_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```



```{r}

### filter for low average cluster size
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_size == "small") %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  # geom_hline(yintercept = .05, linetype = "dashed")  + 
  # geom_hline(yintercept = -.05, linetype = "dashed")  + 
  # geom_boxplot(alpha = .5) + 
  # facet_grid(var_combo_graph ~ icc_est_n_graph) + 
  # labs(x = "Method", y = "Relative Parameter Bias") + 
  # theme_bw() +
  # theme(legend.position = "none",
  #       axis.text.x = element_text(size = 5),
  #       plot.caption=element_text(hjust = 0, size = 10),
  #       legend.title=element_text(size = 11), 
  #       legend.text=element_text(size = 11))
  # 
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_size == "small") %>% 
  #   ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  #   geom_hline(yintercept = .00, linetype = "dashed")  + 
  #   geom_boxplot(alpha = .5) + 
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) + 
  #   labs(x = "Method", y = "RMSE") + 
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11), 
  #         legend.text=element_text(size = 11))
  
```


```{r}


### filter for lower number of clusters
# why would Fisher TF perform better for sample ICCs when they have a low number of clusters? 
# 
# perf_crit %>% group_by(nj_size, var_combo_graph, icc_est_n_graph, method2) %>% tally()
# 
# 
# 
#   perf_crit %>% filter(!grepl('NA', method2))  %>% filter(nj_size == "small") %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
#     geom_hline(yintercept = .05, linetype = "dashed")  + 
#     geom_hline(yintercept = -.05, linetype = "dashed")  + 
#     geom_boxplot(alpha = .5) + 
#     facet_grid(var_combo_graph ~ icc_est_n_graph) + 
#     labs(x = "Method", y = "Relative Parameter Bias") + 
#     theme_bw() +
#     theme(legend.position = "none",
#           axis.text.x = element_text(size = 5),
#           plot.caption=element_text(hjust = 0, size = 10),
#           legend.title=element_text(size = 11), 
#           legend.text=element_text(size = 11))
#   
#   
#   perf_crit %>% filter(!grepl('NA', method2))  %>% filter(nj_size == "small") %>% 
#     ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
#     geom_hline(yintercept = 0, linetype = "dashed")  + 
#     geom_boxplot(alpha = .5) + 
#     facet_grid(var_combo_graph ~ icc_est_n_graph) + 
#     labs(x = "Method", y = "RMSE") + 
#     theme_bw() +
#     theme(legend.position = "none",
#           axis.text.x = element_text(size = 5),
#           plot.caption=element_text(hjust = 0, size = 10),
#           legend.title=element_text(size = 11), 
#           legend.text=element_text(size = 11))
```




```{r}


### filter for small sample size
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_size == "small")  %>% filter(nj_size == "small") %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  #   geom_hline(yintercept = .05, linetype = "dashed")  + 
  #   geom_hline(yintercept = -.05, linetype = "dashed")  + 
  #   geom_boxplot(alpha = .5) + 
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) + 
  #   labs(x = "Method", y = "Relative Parameter Bias") + 
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11), 
  #         legend.text=element_text(size = 11))
  # 
  # 
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_size == "small")  %>% filter(nj_size == "small") %>% 
  #   ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  #   geom_hline(yintercept = 0, linetype = "dashed")  + 
  #   geom_boxplot(alpha = .5) + 
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) + 
  #   labs(x = "Method", y = "RMSE") + 
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11), 
  #         legend.text=element_text(size = 11))
```




```{r}


### filter for higher total sample size

 # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_size == "large") %>% filter(nj_size == "large") %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
 #  geom_hline(yintercept = .05, linetype = "dashed")  + 
 #  geom_hline(yintercept = -.05, linetype = "dashed")  + 
 #  geom_boxplot(alpha = .5) + 
 #  facet_grid(var_combo_graph ~ icc_est_n_graph) + 
 #  labs(x = "Method", y = "Relative Parameter Bias") + 
 #  theme_bw() +
 #  theme(legend.position = "none",
 #        axis.text.x = element_text(size = 5),
 #        plot.caption=element_text(hjust = 0, size = 10),
 #        legend.title=element_text(size = 11), 
 #        legend.text=element_text(size = 11))
 #  
 #  
 #  perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_size == "large") %>% filter(nj_size == "large") %>% 
 #    ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
 #    geom_hline(yintercept = 0, linetype = "dashed")  + 
 #   
 #    geom_boxplot(alpha = .5) + 
 #    facet_grid(var_combo_graph ~ icc_est_n_graph) + 
 #    labs(x = "Method", y = "RMSE") + 
 #    theme_bw() +
 #    theme(legend.position = "none",
 #          axis.text.x = element_text(size = 5),
 #          plot.caption=element_text(hjust = 0, size = 10),
 #          legend.title=element_text(size = 11), 
 #          legend.text=element_text(size = 11))


```



```{r}

### filter for slightly unbalanced cluseters

  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_prop == .1)  %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) +
  # geom_hline(yintercept = .05, linetype = "dashed")  +
  # geom_hline(yintercept = -.05, linetype = "dashed")  +
  # geom_boxplot(alpha = .5) +
  # facet_grid(var_combo_graph ~ icc_est_n_graph) +
  # labs(x = "Method", y = "Relative Parameter Bias") +
  # theme_bw() +
  # theme(legend.position = "none",
  #       axis.text.x = element_text(size = 5),
  #       plot.caption=element_text(hjust = 0, size = 10),
  #       legend.title=element_text(size = 11),
  #       legend.text=element_text(size = 11))
  # 
  # 
  # 
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_prop == .1)  %>%
  #   ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) +
  #   geom_hline(yintercept = 0, linetype = "dashed")  +
  #   geom_boxplot(alpha = .5) +
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) +
  #   labs(x = "Method", y = "RMSE") +
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11),
  #         legend.text=element_text(size = 11))
```



```{r}


### filter for more unbalanced
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_prop == 0.5)  %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) +
  #   geom_hline(yintercept = .05, linetype = "dashed")  +
  #   geom_hline(yintercept = -.05, linetype = "dashed")  +
  #   geom_boxplot(alpha = .5) +
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) +
  #   labs(x = "Method", y = "Relative Parameter Bias") +
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11),
  #         legend.text=element_text(size = 11))
  # 
  # 
  # 
  # perf_crit %>% filter(!grepl('NA', method2)) %>% filter(n_bar_prop == 0.5)  %>%
  #   ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) +
  #   geom_hline(yintercept = 0, linetype = "dashed")  +
  #   geom_boxplot(alpha = .5) +
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) +
  #   labs(x = "Method", y = "RMSE") +
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11),
  #         legend.text=element_text(size = 11))
```



```{r}

### filter for higher sample size and balanced
  # perf_crit %>% filter(!grepl('NA', method2))   %>% filter(n_bar_size == "large") %>% filter(nj_size == "large") %>% 
  # ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  # geom_hline(yintercept = .05, linetype = "dashed")  + 
  # geom_hline(yintercept = -.05, linetype = "dashed")  + 
  # geom_boxplot(alpha = .5) + 
  # facet_grid(var_combo_graph ~ icc_est_n_graph) + 
  # labs(x = "Method", y = "Relative Parameter Bias") + 
  # theme_bw() +
  # theme(legend.position = "none",
  #       axis.text.x = element_text(size = 5),
  #       plot.caption=element_text(hjust = 0, size = 10),
  #       legend.title=element_text(size = 11), 
  #       legend.text=element_text(size = 11))
  # 
  # 
  # perf_crit %>% filter(!grepl('NA', method2))  %>% filter(n_bar_size == "large") %>% filter(nj_size == "large") %>% 
  #   ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  #   geom_hline(yintercept = 0, linetype = "dashed")  + 
  #   geom_boxplot(alpha = .5) + 
  #   facet_grid(var_combo_graph ~ icc_est_n_graph) + 
  #   labs(x = "Method", y = "RMSE") + 
  #   theme_bw() +
  #   theme(legend.position = "none",
  #         axis.text.x = element_text(size = 5),
  #         plot.caption=element_text(hjust = 0, size = 10),
  #         legend.title=element_text(size = 11), 
  #         legend.text=element_text(size = 11))

```


## Main Effects

### just between study heterogeniety

```{r}

perf_crit %>% group_by(tau, method2) %>% tally()



perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( rows = vars(tau)
              #labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars(tau)
            #  labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

```



### just number of iccs pooled

```{r}

perf_crit %>% group_by(icc_est_n_graph, method2) %>% tally()



perf_crit %>% group_by(var_combo_graph, icc_est_n_graph, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( rows = vars(icc_est_n_graph)
              #labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars(icc_est_n_graph)
            #  labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

```
### just variance

```{r}

perf_crit %>% group_by(var_combo_graph, method2) %>% tally()



perf_crit %>% group_by(var_combo_graph, icc_est_n_graph, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( rows = vars(var_combo_graph)
              #labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars(var_combo_graph)
            #  labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

```


### just number clusters

```{r}

perf_crit %>% group_by(var_combo_graph, method2) %>% tally()





perf_crit %>% filter(!grepl('NA', variance)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( rows = vars(nj_size)
              #labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars(nj_size)
            #  labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

```


### just clustersize

```{r}

perf_crit %>% group_by(var_combo_graph, method2) %>% tally()





perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( rows = vars(n_bar_size)
              #labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_icc, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars(n_bar_size)
            #  labeller = label_parsed
              ) + 
  labs(x = "Method", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

```


# SE of ICC

## Interactions

### var_combo vs num pooled ICCs
using mean
```{r}

#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=800)
#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=300)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RSEB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_numICC.png", width = 6.8, height = 5, units = "in")

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

```

using median


```{r}

#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=800)
#tiff("RPB_numICC.tiff", units="in", width=8, height=5, res=300)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_numICC_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC_median, fill = model)) + 
   geom_hline(yintercept = .00, linetype = "dashed")  + 

  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ icc_est_n, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = k ==.(icc_est_n))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_se_numICC_median.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```





### var_combo vs tau (between study )

using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_tau.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed") + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_se_tau.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```


using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_tau_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed") + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ tau, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = tau==.(tau))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_se_tau_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```



### var_combo vs number of clusters

using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_j.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_se_j.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```


using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)




perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_j_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ nj_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = j== .(nj_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )
ggsave("RMSE_se_j_median.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```

### var_combo vs cluster size

using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_nj.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_se_nj.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```



using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_nj_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( var_combo_graph ~ n_bar_size, 
             labeller = label_bquote(rows = rho ==.(var_combo_graph), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_se_nj_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```


### number clusters vs cluster size
using mean
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_j_nj.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_se_j_nj.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```
using median
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit %>% group_by(var_combo_graph, tau, method2) %>% tally()


perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RPB", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_se_j_nj_median.png", width = 6.8, height = 5, units = "in")



# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit %>% filter(!grepl('NA', method2)) %>% ggplot( aes( x = variance, y = RMSE_rel_bias_se_ICC_median, fill = model)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid( nj_size ~ n_bar_size, 
             labeller = label_bquote(rows = j ==.(nj_size), 
                                            cols = bar(n_j)==.(n_bar_size))) + 
  labs(x = NULL, y = "RMSE", fill = NULL) + 
  theme_bw() +
  theme(
    legend.position = "bottom",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),

        plot.caption=element_text(hjust = 0, size = 6),
       # legend.title=element_text(size = 6), 
        legend.text=element_text(size = 6.5),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
      #  strip.background =element_rect(fill="white")
        strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_se_j_nj_median.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```




# L2 Variance

```{r}



perf_crit2$var_combo_graph <- factor(perf_crit2$var_combo,labels=c(
  'small_large'=0.05,
  'medium_large'=0.15,
  'large_large'=0.25)) 

# perf_crit2 <- perf_crit2 %>% mutate(
#   var_combo_graph = case_when(
#     var_combo == 'small_large' ~ 0.05,
#     var_combo == 'medium_large' ~ 0.15,
#     var_combo == 'large_large' ~ 0.25,
#   )
# ) 


perf_crit2 <- perf_crit2 %>% mutate(
  nj_size = case_when(
    nj_size == "small" ~'U[30, 50]',

    nj_size == "large" ~'U[50, 100]',
  ))
  


perf_crit2 <- perf_crit2 %>% mutate(
  n_bar_size = case_when(
    n_bar_size == "small" ~'U[10, 30]',

    n_bar_size == "large" ~'U[30, 50]',
  ))
  



# levels(perf_crit$var_combo) <- c( 
#  
#   
#   expression( atop( tau^"2"*"= .05", rho*"= 0.05") ),
#   expression( atop(tau^"2"*"= .15", rho*"= 0.15")),
#   expression( atop(tau^"2"*"= .25", rho*"= 0.25")),
#   expression( atop(tau^"2"*"= 5", rho*"= 0.05")),
#   expression( atop(tau^"2"*"= 15", rho*"= 0.15")),
#   expression( atop(tau^"2"*"= 25", rho*"= 0.25")))


perf_crit2 <- perf_crit2 %>% mutate(
                                  #n_bar_graph = paste("n_bar_size = ", n_bar_size), 
                                 # nj_graph = paste("nj_size = ", nj_size), 
                                  
                                  icc_est_n_graph = paste("k = ", icc_est_n)
                                  #,
                                  # var_combo_graph = case_when(
                                  #   var_combo == "large_large" ~ "Large /tau^2 // Large Total Var.",
                                  #   var_combo == "small_small" ~ "Small /tau^2 // Small Total Var.",
                                  #   var_combo == "medium_small" ~ "Medium /tau^2 // Small Total Var.",
                                  #   var_combo == "large_small" ~ "Large /tau^2 // Small Total Var.",
                                  #   var_combo == "small_large" ~ "Small /tau^2 // Large Total Var.",
                                  #   var_combo == "medium_large" ~ "Medium /tau^2 // Large Total Var.",

                                 # )
                                  #,
                                  #var_combo_graph = str_replace(var_combo, "_", "/\n")
                                  )

perf_crit2$icc_est_n_graph <- factor(perf_crit2$icc_est_n_graph,levels=c(
  "20",
  "50",
  "100"))



```

## Main Effects

### L2 variance by method
mean RPB
```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_clus)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
 # facet_grid( rows = vars(var_combo_graph)
              #labeller = label_parsed
#              ) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_clus, fill = var_combo_graph)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code
#dev.off()

```

median RPB

```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_clus3)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
 # facet_grid( rows = vars(var_combo_graph)
              #labeller = label_parsed
#              ) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)

# 
perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_clus_median, fill = var_combo_graph)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code
#dev.off()

```




### L2 variance by tau

mean
```{r}



perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_clus)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
#  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(tau )
             , 
             labeller = label_bquote(cols = tau ==.(tau))) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_L2_tau_mean.png", width = 6.8, height = 5, units = "in")




perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_clus)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
#  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(tau )
             , 
             labeller = label_bquote(cols = tau ==.(tau))) + 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_L2_tau_mean.png", width = 6.8, height = 5, units = "in")

# insert ggplot code
#dev.off()

```

median
```{r}



perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_clus3)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
#  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(tau )
             , 
             labeller = label_bquote(cols = tau ==.(tau))) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_L2_tau_med.png", width = 6.8, height = 5, units = "in")




perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_clus_median)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
#  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(tau )
             , 
             labeller = label_bquote(cols = tau ==.(tau))) + 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_L2_tau_med.png", width = 6.8, height = 5, units = "in")


# insert ggplot code
#dev.off()

```


### L2 variance by clustersize



mean
```{r}



perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_clus)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
#  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(nj_size )
             , 
             labeller = label_bquote(cols = j ==.(nj_size))) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_L2_j_mean.png", width = 6.8, height = 5, units = "in")




perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_clus)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(nj_size )
             , 
             labeller = label_bquote(cols = j ==.(nj_size))) + 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_L2_j_mean.png", width = 6.8, height = 5, units = "in")




```

median
```{r}


perf_crit2 %>% group_by(nj_size, var_combo_graph) %>% tally()

perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_clus3)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
#  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(nj_size )
             , 
             labeller = label_bquote(cols = j ==.(nj_size))) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RPB_L2_j_med.png", width = 6.8, height = 5, units = "in")


perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_clus_median)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(cols = vars(nj_size )
             , 
             labeller = label_bquote(cols = j ==.(nj_size))) + 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6.5),
        axis.text.y = element_text(size = 6.5),
      #  plot.caption=element_text(hjust = 0, size = 8),
      #  legend.title=element_text(size = 8), 
      #  legend.text=element_text(size = 8),
        axis.title.x = element_text(size=6.5),
        axis.title.y = element_text(size=6.5),
       strip.text.x = element_text(size = 6.5, face="bold"),
        strip.text.y = element_text(size = 6.5, face="bold")
      )

ggsave("RMSE_L2_j_med.png", width = 6.8, height = 5, units = "in")




# insert ggplot code
#dev.off()

```


# L1 Variance

## main effects

### by method

```{r}



perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_res, fill = var_combo_graph)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
 # facet_grid( rows = vars(var_combo_graph)
              #labeller = label_parsed
#              ) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_res, fill = var_combo_graph)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code
#dev.off()


```



### L1 variance by Tau 


```{r}

#tiff("test.tiff", units="in", width=8.5, height=5.5, res=700)

perf_crit2 %>% group_by(nj_size, var_combo_graph) %>% tally()

perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = rel_bias_res, fill = var_combo_graph)) + 
  geom_hline(yintercept = .05, linetype = "dashed")  + 
  geom_hline(yintercept = -.05, linetype = "dashed")  + 
  geom_hline(yintercept = 0, linetype = "solid", colour = "red")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars(tau) ) + 
  labs(x = "Var Combo", y = "RPB") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code

#dev.off()

#tiff("test2.tiff", units="in", width=8.5, height=5.5, res=700)


perf_crit2  %>% ggplot( aes( x = var_combo_graph, y = RMSE_rel_bias_res, fill = var_combo_graph)) + 
  geom_hline(yintercept = .00, linetype = "dashed")  + 
  geom_boxplot(alpha = .5) + 
  facet_grid(rows = vars( tau)) + 
 
  labs(x = "Var Combo", y = "RMSE") + 
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 6, face="bold"),
        plot.caption=element_text(hjust = 0, size = 8),
        legend.title=element_text(size = 8), 
        legend.text=element_text(size = 8),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        strip.background =element_rect(fill="white"))

# insert ggplot code
#dev.off()

```

